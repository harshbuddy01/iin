<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center | IIN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
        svg: { fontCache: 'global' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #0f1419;
            --bg-tertiary: #1a1f2e;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #2d3748;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            display: flex; 
            height: 100vh; 
            background: var(--bg-primary);
            color: var(--text-primary); 
            overflow: hidden; 
        }

        /* ===== SIDEBAR ===== */
        .sidebar { 
            width: 280px; 
            background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }
        
        .logo-area { 
            padding: 30px 25px; 
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
        }
        
        .logo { 
            font-size: 1.8rem; 
            font-weight: 800; 
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-badge {
            font-size: 0.65rem;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .nav-links { 
            flex: 1; 
            padding: 25px 0; 
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 25px;
        }
        
        .nav-section-title {
            padding: 0 25px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .nav-item { 
            padding: 15px 25px; 
            cursor: pointer; 
            color: var(--text-secondary); 
            transition: all 0.3s ease;
            display: flex; 
            align-items: center; 
            gap: 15px; 
            font-size: 0.95rem;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item i {
            width: 20px;
            font-size: 1.1rem;
        }
        
        .nav-item:hover { 
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
            padding-left: 30px;
        }
        
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2) 0%, transparent 100%);
            color: white;
            border-left: 4px solid var(--accent);
            font-weight: 600;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--accent);
            border-radius: 10px 0 0 10px;
        }

        .logout-section { 
            padding: 20px 25px; 
            border-top: 1px solid var(--border);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .logout { 
            color: var(--danger); 
            cursor: pointer; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: 0.3s;
        }
        
        .logout:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: translateX(5px);
        }

        /* ===== MAIN CONTENT ===== */
        .main { 
            flex: 1; 
            padding: 35px 40px; 
            overflow-y: auto;
            background: var(--bg-secondary);
        }
        
        .main::-webkit-scrollbar { width: 8px; }
        .main::-webkit-scrollbar-track { background: var(--bg-primary); }
        .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .time-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .current-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .current-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ===== STATS CARDS ===== */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-bottom: 35px; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 25px; 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .stat-num { 
            font-size: 2.5rem; 
            font-weight: 800; 
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .stat-label { 
            color: var(--text-secondary); 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        /* ===== CONTENT CARDS ===== */
        .card { 
            background: var(--bg-tertiary);
            padding: 40px; 
            border-radius: 20px; 
            border: 1px solid var(--border); 
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card.active { 
            display: block; 
            animation: slideIn 0.4s ease;
        }
        
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ===== FORMS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group { 
            margin-bottom: 25px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px 16px; 
            background: var(--bg-secondary);
            border: 2px solid var(--border); 
            color: var(--text-primary);
            border-radius: 10px; 
            font-size: 0.95rem; 
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent);
            outline: none; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: var(--bg-primary);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* ===== BUTTONS ===== */
        .btn { 
            padding: 14px 32px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700;
            border: none; 
            transition: all 0.3s;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white; 
            width: 100%; 
            justify-content: center;
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* ===== TABLES ===== */
        .table-container { 
            margin-top: 25px; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse;
        }
        
        thead {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
        }
        
        th, td { 
            padding: 18px 20px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        
        th { 
            color: var(--text-secondary);
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 0.75rem;
            letter-spacing: 1.5px;
        }
        
        tbody tr {
            transition: all 0.2s;
        }
        
        tbody tr:hover { 
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== BADGES ===== */
        .badge { 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .badge-phys { 
            background: rgba(59, 130, 246, 0.15); 
            color: #3b82f6; 
            border: 1.5px solid #3b82f6; 
        }
        
        .badge-chem { 
            background: rgba(239, 68, 68, 0.15); 
            color: #ef4444; 
            border: 1.5px solid #ef4444; 
        }
        
        .badge-math { 
            background: rgba(234, 179, 8, 0.15); 
            color: #eab308; 
            border: 1.5px solid #eab308; 
        }
        
        .badge-bio { 
            background: rgba(16, 185, 129, 0.15); 
            color: #10b981; 
            border: 1.5px solid #10b981; 
        }

        /* ===== MODALS ===== */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(10px);
        }
        
        .modal-content { 
            background: var(--bg-tertiary);
            width: 90%; 
            max-width: 1200px;
            height: 85%; 
            border-radius: 20px; 
            padding: 40px; 
            overflow-y: auto; 
            border: 1px solid var(--border);
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .close-modal { 
            position: absolute; 
            top: 25px; 
            right: 30px; 
            font-size: 2rem; 
            color: var(--danger);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .close-modal:hover {
            transform: rotate(90deg) scale(1.2);
        }

        /* ===== IMAGE PREVIEW ===== */
        .preview-container {
            margin-top: 15px;
            display: none;
        }
        
        .preview-container.show {
            display: block;
        }
        
        .preview-image { 
            max-width: 300px; 
            max-height: 300px; 
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            background: var(--bg-secondary);
        }
        
        .table-img { 
            height: 60px; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid var(--border);
            transition: 0.3s;
        }
        
        .table-img:hover {
            transform: scale(1.5);
            border-color: var(--accent);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        /* ===== ACTION BUTTONS ===== */
        .action-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 1rem;
        }
        
        .action-btn:hover {
            transform: scale(1.2);
        }
        
        .btn-delete {
            color: var(--danger);
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .btn-view {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        /* ===== LOADING STATES ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== SEARCH BAR ===== */
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            padding-left: 45px;
        }
        
        .search-bar i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                IIN ADMIN
                <span class="admin-badge">CONTROL</span>
            </div>
        </div>
        
        <div class="nav-links">
            <div class="nav-section">
                <div class="nav-section-title">Dashboard</div>
                <div class="nav-item active" onclick="switchTab('overview')">
                    <i class="fas fa-chart-line"></i>
                    Analytics Overview
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Questions</div>
                <div class="nav-item" onclick="switchTab('upload')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload Question
                </div>
                <div class="nav-item" onclick="switchTab('manage')">
                    <i class="fas fa-tasks"></i>
                    Manage Repository
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Student Data</div>
                <div class="nav-item" onclick="switchTab('students')">
                    <i class="fas fa-users"></i>
                    All Students
                </div>
                <div class="nav-item" onclick="switchTab('results')">
                    <i class="fas fa-chart-bar"></i>
                    Test Results
                </div>
                <div class="nav-item" onclick="switchTab('feedbacks')">
                    <i class="fas fa-comments"></i>
                    Feedback & Reviews
                </div>
            </div>
        </div>
        
        <div class="logout-section">
            <div class="logout" onclick="logout()">
                <i class="fas fa-power-off"></i>
                Logout
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <h1>Command Center</h1>
            <div class="header-right">
                <div class="time-display">
                    <div class="current-time" id="currentTime">00:00:00</div>
                    <div class="current-date" id="currentDate">Loading...</div>
                </div>
            </div>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="card active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.15); color: #6366f1;">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="stat-num" id="statTotal">0</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.15); color: #3b82f6;">
                        <i class="fas fa-atom"></i>
                    </div>
                    <div class="stat-num" id="statPhy">0</div>
                    <div class="stat-label">Physics</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">
                        <i class="fas fa-flask"></i>
                    </div>
                    <div class="stat-num" id="statChem">0</div>
                    <div class="stat-label">Chemistry</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(234, 179, 8, 0.15); color: #eab308;">
                        <i class="fas fa-square-root-alt"></i>
                    </div>
                    <div class="stat-num" id="statMath">0</div>
                    <div class="stat-label">Mathematics</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                        <i class="fas fa-dna"></i>
                    </div>
                    <div class="stat-num" id="statBio">0</div>
                    <div class="stat-label">Biology</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6;">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-num" id="statStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(236, 72, 153, 0.15); color: #ec4899;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-num" id="statResults">0</div>
                    <div class="stat-label">Submissions</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b;">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-num" id="statFeedbacks">0</div>
                    <div class="stat-label">Feedbacks</div>
                </div>
            </div>
        </div>

        <!-- UPLOAD TAB -->
        <div id="tab-upload" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Deploy New Question
                </h2>
            </div>
            
            <form onsubmit="event.preventDefault(); uploadQuestion();">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-graduation-cap"></i> Test Series</label>
                        <select id="testId" required>
                            <option value="iat">IAT Test Series</option>
                            <option value="nest">NEST Test Series</option>
                            <option value="isi">ISI Test Series</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-book"></i> Subject</label>
                        <select id="subject" required>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-align-left"></i> Question Text (Use $ for Math: e.g., $H_2O$ or $\int x dx$)</label>
                    <textarea id="questionText" rows="4" placeholder="Enter question content..." required></textarea>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-image"></i> Upload Diagram (Optional)</label>
                    <input type="file" id="qImage" accept="image/*" onchange="previewImage()">
                    <div class="preview-container" id="previewContainer">
                        <img id="imgPreview" class="preview-image">
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-list"></i> Answer Options</label>
                    <div class="form-grid">
                        <input type="text" id="opt1" placeholder="Option A" required>
                        <input type="text" id="opt2" placeholder="Option B" required>
                        <input type="text" id="opt3" placeholder="Option C" required>
                        <input type="text" id="opt4" placeholder="Option D" required>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-check-circle"></i> Correct Answer (Paste exact option text)</label>
                    <input type="text" id="correctAnswer" placeholder="Enter correct answer" required>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-rocket"></i>
                    Deploy Question to Database
                </button>
            </form>
        </div>

        <!-- MANAGE TAB -->
        <div id="tab-manage" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-database"></i>
                    Question Repository
                </h2>
                <button class="btn btn-secondary" onclick="loadAllQuestions()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
            
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchQuestions" placeholder="Search questions..." oninput="filterQuestions()">
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">Subject</th>
                            <th width="50%">Question</th>
                            <th width="10%">Image</th>
                            <th width="20%">Answer</th>
                            <th width="10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="questionsTable">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading questions...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- STUDENTS TAB -->
        <div id="tab-students" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-users"></i>
                    Student Database
                </h2>
                <button class="btn btn-secondary" onclick="loadStudents()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
            
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchStudents" placeholder="Search students..." oninput="filterStudents()">
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Email</th>
                            <th>Purchased Tests</th>
                            <th>Registration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading students...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RESULTS TAB -->
        <div id="tab-results" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Test Results & Performance
                </h2>
                <button class="btn btn-secondary" onclick="loadResults()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Email</th>
                            <th>Test ID</th>
                            <th>Submission Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading results...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FEEDBACKS TAB -->
        <div id="tab-feedbacks" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-comments"></i>
                    Student Feedback & Reviews
                </h2>
                <button class="btn btn-secondary" onclick="loadFeedbacks()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Email</th>
                            <th>Test ID</th>
                            <th>Ratings (L/I/Q/S)</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTable">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading feedbacks...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- RESPONSE MODAL -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modalStudentName" style="color: var(--accent); margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                <i class="fas fa-file-alt"></i>
                Detailed Response Sheet
            </h2>
            <div id="sheetContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE_URL = "https://iin-production.up.railway.app";
        
        // AUTH CHECK
        if (localStorage.getItem("adminKey") !== "secret_unlocked") {
            window.location.href = "adminlogin.html";
        }
        
        function logout() {
            if(confirm('Are you sure you want to logout?')) {
                localStorage.removeItem("adminKey");
                window.location.href = "adminlogin.html";
            }
        }

        // TIME DISPLAY
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString();
            document.getElementById('currentDate').innerText = now.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // TAB SWITCHING
        function switchTab(tabName) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if(tabName === 'manage') loadAllQuestions();
            if(tabName === 'students') loadStudents();
            if(tabName === 'results') loadResults();
            if(tabName === 'feedbacks') loadFeedbacks();
        }

        // IMAGE PREVIEW
        let base64Image = "";
        function previewImage() {
            const file = document.getElementById("qImage").files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onloadend = () => {
                base64Image = reader.result;
                document.getElementById("imgPreview").src = base64Image;
                document.getElementById("previewContainer").classList.add('show');
            };
            reader.readAsDataURL(file);
        }

        // UPLOAD QUESTION
        async function uploadQuestion() {
            const data = {
                testId: document.getElementById("testId").value,
                subject: document.getElementById("subject").value,
                questionText: document.getElementById("questionText").value,
                image: base64Image,
                options: [
                    document.getElementById("opt1").value,
                    document.getElementById("opt2").value,
                    document.getElementById("opt3").value,
                    document.getElementById("opt4").value
                ],
                correctAnswer: document.getElementById("correctAnswer").value
            };

            try {
                const res = await axios.post(`${API_BASE_URL}/api/upload-question`, data);
                if(res.data.success) {
                    alert("✅ Question successfully deployed to database!");
                    resetForm();
                    loadAllQuestions();
                    updateStats();
                }
            } catch (e) {
                alert("❌ Upload failed: " + (e.response?.data?.message || e.message));
            }
        }

        function resetForm() {
            document.getElementById("questionText").value = "";
            document.getElementById("correctAnswer").value = "";
            ['opt1', 'opt2', 'opt3', 'opt4'].forEach(id => document.getElementById(id).value = "");
            document.getElementById("qImage").value = "";
            document.getElementById("previewContainer").classList.remove('show');
            base64Image = "";
        }

        // LOAD QUESTIONS
        async function loadAllQuestions() {
            const tbody = document.getElementById("questionsTable");
            tbody.innerHTML = "<tr><td colspan='5' class='loading'><div class='spinner'></div>Loading...</td></tr>";
            
            try {
                const res = await axios.get(`${API_BASE_URL}/api/admin/all-questions`);
                if(res.data.success) {
                    const questions = res.data.questions;
                    tbody.innerHTML = "";
                    
                    if(questions.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px;'>No questions found</td></tr>";
                        return;
                    }
                    
                    questions.forEach(q => {
                        const badgeClass = q.subject === "Physics" ? "badge-phys" : 
                                          q.subject === "Chemistry" ? "badge-chem" : 
                                          q.subject === "Mathematics" ? "badge-math" : "badge-bio";
                        
                        tbody.innerHTML += `
                            <tr>
                                <td><span class="badge ${badgeClass}">${q.subject}</span></td>
                                <td style="font-size: 0.9rem;">${q.questionText.substring(0, 100)}${q.questionText.length > 100 ? '...' : ''}</td>
                                <td>${q.image ? `<img src="${q.image}" class="table-img" onclick="window.open(this.src)">` : '-'}</td>
                                <td style="color: var(--success); font-weight: 600;">${q.correctAnswer.substring(0, 30)}${q.correctAnswer.length > 30 ? '...' : ''}</td>
                                <td>
                                    <button class="action-btn btn-delete" onclick="deleteQuestion('${q._id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    updateStats();
                    if(window.MathJax) MathJax.typeset();
                }
            } catch(e) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color: var(--danger);'>Failed to load questions</td></tr>";
            }
        }

        async function deleteQuestion(id) {
            if(!confirm("Are you sure you want to delete this question permanently?")) return;
            
            try {
                await axios.delete(`${API_BASE_URL}/api/admin/delete-question/${id}`);
                alert("✅ Question deleted successfully");
                loadAllQuestions();
            } catch(e) {
                alert("❌ Failed to delete question");
            }
        }

        function filterQuestions() {
            const searchTerm = document.getElementById('searchQuestions').value.toLowerCase();
            const rows = document.querySelectorAll('#questionsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // LOAD STUDENTS
        async function loadStudents() {
            const tbody = document.getElementById("studentsTable");
            tbody.innerHTML = "<tr><td colspan='5' class='loading'><div class='spinner'></div>Loading...</td></tr>";
            
            try {
                const res = await axios.get(`${API_BASE_URL}/api/admin/all-students`);
                if(res.data.success) {
                    const students = res.data.students;
                    tbody.innerHTML = "";
                    
                    if(students.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px;'>No students found</td></tr>";
                        return;
                    }
                    
                    students.forEach(s => {
                        const tests = s.purchasedTests && s.purchasedTests.length > 0 
                            ? s.purchasedTests.map(t => `<span class="badge" style="margin:2px;">${t.toUpperCase()}</span>`).join(' ')
                            : '<span style="color: var(--text-secondary);">None</span>';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td style="color: var(--warning); font-weight: 700;">${s.rollNumber || 'N/A'}</td>
                                <td>${s.email}</td>
                                <td>${tests}</td>
                                <td style="font-size: 0.85rem;">${new Date(s.createdAt || Date.now()).toLocaleDateString()}</td>
                                <td>
                                    <button class="action-btn" style="color: var(--accent);" onclick="viewStudentDetails('${s._id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('statStudents').innerText = students.length;
                }
            } catch(e) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color: var(--danger);'>Failed to load students</td></tr>";
            }
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // LOAD RESULTS
        let cachedResultsData = [];
        async function loadResults() {
            const tbody = document.getElementById("resultsTable");
            tbody.innerHTML = "<tr><td colspan='5' class='loading'><div class='spinner'></div>Loading...</td></tr>";
            
            try {
                const res = await axios.get(`${API_BASE_URL}/api/admin/results`);
                if(res.data.success) {
                    const { results, questions } = res.data;
                    cachedResultsData = { results, questions };
                    tbody.innerHTML = "";
                    
                    if(results.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px;'>No results found</td></tr>";
                        return;
                    }
                    
                    results.forEach((r, idx) => {
                        tbody.innerHTML += `
                            <tr>
                                <td style="color: var(--warning); font-weight: 700;">${r.rollNumber || 'N/A'}</td>
                                <td>${r.email}</td>
                                <td><span class="badge">${r.testId.toUpperCase()}</span></td>
                                <td style="font-size: 0.85rem;">${new Date(r.submissionTime).toLocaleString()}</td>
                                <td>
                                    <button class="btn-view" onclick="viewResponseSheet(${idx})">
                                        <i class="fas fa-file-alt"></i>
                                        View Response
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('statResults').innerText = results.length;
                }
            } catch(e) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color: var(--danger);'>Failed to load results</td></tr>";
            }
        }

        function viewResponseSheet(idx) {
            const r = cachedResultsData.results[idx];
            const testQs = cachedResultsData.questions.filter(q => q.testId === r.testId);
            
            let organized = [];
            ["Physics", "Chemistry", "Mathematics", "Biology"].forEach(subject => {
                organized = organized.concat(testQs.filter(q => q.subject === subject));
            });

            let html = `
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: var(--accent); margin-bottom: 10px;">Student Information</h3>
                    <p><strong>Email:</strong> ${r.email}</p>
                    <p><strong>Roll Number:</strong> ${r.rollNumber || 'N/A'}</p>
                    <p><strong>Test:</strong> ${r.testId.toUpperCase()}</p>
                    <p><strong>Submission:</strong> ${new Date(r.submissionTime).toLocaleString()}</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Question</th>
                                <th>Student Answer</th>
                                <th>Correct Answer</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let counters = { "Physics": 0, "Chemistry": 0, "Mathematics": 0, "Biology": 0 };
            let totalScore = 0;

            organized.forEach(q => {
                const key = `${q.subject}-${counters[q.subject]}`;
                counters[q.subject]++;
                
                const userAnswerIndex = r.answers[key];
                const userAnswer = userAnswerIndex !== undefined ? q.options[userAnswerIndex] : "SKIPPED";
                const isCorrect = userAnswer === q.correctAnswer;
                const points = userAnswer === "SKIPPED" ? 0 : isCorrect ? 4 : -1;
                totalScore += points;
                
                const statusColor = userAnswer === "SKIPPED" ? "var(--text-secondary)" : isCorrect ? "var(--success)" : "var(--danger)";
                const statusText = userAnswer === "SKIPPED" ? "0" : isCorrect ? "+4" : "-1";

                html += `
                    <tr>
                        <td><span class="badge badge-${q.subject.toLowerCase().substring(0,4)}">${q.subject}</span></td>
                        <td style="font-size: 0.85rem;">${q.questionText.substring(0, 80)}...</td>
                        <td>${userAnswer.substring(0, 30)}${userAnswer.length > 30 ? '...' : ''}</td>
                        <td style="color: var(--success);">${q.correctAnswer.substring(0, 30)}${q.correctAnswer.length > 30 ? '...' : ''}</td>
                        <td style="color: ${statusColor}; font-weight: 700;">${statusText}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px; text-align: center;">
                    <h2 style="color: var(--accent); font-size: 2rem;">Total Score: ${totalScore}</h2>
                </div>
            `;
            
            document.getElementById("modalStudentName").innerHTML = `<i class="fas fa-file-alt"></i> Response Sheet: ${r.email}`;
            document.getElementById("sheetContent").innerHTML = html;
            document.getElementById("responseModal").style.display = "flex";
            
            if(window.MathJax) MathJax.typeset();
        }

        // LOAD FEEDBACKS
        async function loadFeedbacks() {
            const tbody = document.getElementById("feedbackTable");
            tbody.innerHTML = "<tr><td colspan='5' class='loading'><div class='spinner'></div>Loading...</td></tr>";
            
            try {
                const res = await axios.get(`${API_BASE_URL}/api/admin/feedbacks`);
                if(res.data.success) {
                    const feedbacks = res.data.feedbacks;
                    tbody.innerHTML = "";
                    
                    if(feedbacks.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px;'>No feedbacks found</td></tr>";
                        return;
                    }
                    
                    feedbacks.forEach(f => {
                        const r = f.ratings || {};
                        tbody.innerHTML += `
                            <tr>
                                <td style="color: var(--warning); font-weight: 700;">${f.rollNumber || 'N/A'}</td>
                                <td>${f.email}<br><small style="color: var(--text-secondary);">${(f.testId || '').toUpperCase()}</small></td>
                                <td><span class="badge">${(f.testId || 'N/A').toUpperCase()}</span></td>
                                <td style="font-size: 0.9rem;">
                                    <span style="color: var(--accent);">Login:</span> ${r.login || 0}/5 &nbsp;
                                    <span style="color: var(--success);">Interface:</span> ${r.interface || 0}/5 &nbsp;
                                    <span style="color: var(--warning);">Quality:</span> ${r.quality || 0}/5 &nbsp;
                                    <span style="color: #ec4899;">Server:</span> ${r.server || 0}/5
                                </td>
                                <td style="font-style: italic; color: var(--text-secondary);">${f.comment || 'No comment provided'}</td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('statFeedbacks').innerText = feedbacks.length;
                }
            } catch(e) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color: var(--danger);'>Failed to load feedbacks</td></tr>";
            }
        }

        // UPDATE STATS
        async function updateStats() {
            try {
                const [qRes, sRes, rRes, fRes] = await Promise.all([
                    axios.get(`${API_BASE_URL}/api/admin/all-questions`),
                    axios.get(`${API_BASE_URL}/api/admin/all-students`),
                    axios.get(`${API_BASE_URL}/api/admin/results`),
                    axios.get(`${API_BASE_URL}/api/admin/feedbacks`)
                ]);
                
                if(qRes.data.success) {
                    const questions = qRes.data.questions;
                    document.getElementById('statTotal').innerText = questions.length;
                    document.getElementById('statPhy').innerText = questions.filter(q => q.subject === 'Physics').length;
                    document.getElementById('statChem').innerText = questions.filter(q => q.subject === 'Chemistry').length;
                    document.getElementById('statMath').innerText = questions.filter(q => q.subject === 'Mathematics').length;
                    document.getElementById('statBio').innerText = questions.filter(q => q.subject === 'Biology').length;
                }
                
                if(sRes.data.success) {
                    document.getElementById('statStudents').innerText = sRes.data.students.length;
                }
                
                if(rRes.data.success) {
                    document.getElementById('statResults').innerText = rRes.data.results.length;
                }
                
                if(fRes.data.success) {
                    document.getElementById('statFeedbacks').innerText = fRes.data.feedbacks.length;
                }
            } catch(e) {
                console.error('Failed to update stats:', e);
            }
        }

        function closeModal() {
            document.getElementById('responseModal').style.display = 'none';
        }

        // Initialize
        updateStats();
        loadAllQuestions();
    </script>
</body>
</html>